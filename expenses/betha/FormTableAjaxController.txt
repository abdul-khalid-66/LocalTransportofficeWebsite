<?php

// All AJAX LOGIC Code 
header('Content-Type: application/json');

$rootDirectoryFileSelect = $_SERVER['DOCUMENT_ROOT'] . "/LocalTransportofficeWebsite/";
include_once $rootDirectoryFileSelect ."/includes/functions.php";
include_once $rootDirectoryFileSelect ."/components/components.php";


if (isset($_POST['selectedContractorId'])) {
    $pkContractorId = $_POST['selectedContractorId'];
    $selectedContractorName = $_POST['selectedContractorName'];
    $pkContractorId = $_POST['selectedContractorId'];
    $CrudOperation = new CrudOperation();

    

    $table = "contractorkhata";
    $columns = " pkContractorKhataId , vehicleRegistrationNo , createdOn , destinationAddress , measurement	, price , allowance , totalAmount	, processDescription , fkContractorId";
    $where = " fkContractorId = ". $pkContractorId;
    $orderBy = " pkContractorKhataId	Desc";
    $limit = 1;

    $formResult = $CrudOperation->readRecords($table, $columns, $where, null, null, $limit, null,$orderBy);
    if (empty($formResult)) {     
        $totalAmount = 0;
    }else{
        $totalAmount = $formResult[0]['totalAmount'];
    }
              
    $constructionMaterials = [
        "کرش",
        "سیمنٹ",
        "بجری",
        "ریتی",
    ];
    
    $contractorBathaForm = '
    <h1 id="changeColor">hellow</h1>
                <div class="col-md-4 text-end">
                    <label for="siteSelection" class="form-label">: سائٹ</label>
                    <input type="text" class="form-control text-end" id="siteSelection" name="siteSelection"
                        placeholder="جگہ کا نام بتائیں">
                </div>
                <div class="col-md-4 text-end">
                    <label for="vehicleNumber" class="form-label"> : گاڑی نمبر</label>
                    <input type="text" class="form-control text-end" id="vehicleNumber" name="vehicleNumber"
                        placeholder="گاڑی کا نمبر لکھیں">
                </div>
                <div class="col-md-4 text-end">
                        
                <label for="Material" class="form-label"> :  مواد کی قسم</label>
                <select id="Material" name="Material" class="form-select">
                    <option selected class="text-end" value="NULL">مواد کی قسم کو منتخب کریں۔</option>';                    
                                foreach ($constructionMaterials as $material) {
                                    $contractorBathaForm .= '<option class="text-end pe-1" value="' . $material . '">' . $material . '</option>';
                                }
                $contractorBathaForm .= '</select>
                </div>
                <div class=" col-md-4 text-end">
                    <label for="allowance" class="form-label"> : رقم</label>
                    <input type="number" class="form-control" id="allowance" name="allowance" >
                </div>
                <div class="col" style="text-align: center;">
                    <div style="margin-top: 40px;">=</div>
                </div>
                <div class="col-md-3 text-end">
                    <label for="NumberOfSankra" class="form-label">: ٹن/پیمائش</label>
                    <input type="number" class="form-control" id="NumberOfSankra"  value="0" oninput="calculateResult();" name="NumberOfSankra"
                        placeholder="گاڑی کی پیمائش درج کریں">
                </div>
                <div class="col-md-4 text-end">
                    <label for="ratePerSankra" class="form-label">: ریٹ</label>
                    <input type="number" class="form-control" id="ratePerSankra" name="ratePerSankra" value="0" placeholder="سینکڑا کی قیمت لکھیں"
                        oninput="calculateResult();">
                </div>                
                <div class="col-md-12 text-end">
                        <label for="description" class="text-end" >کوئی تفصیل </label>
                        <textarea class="form-control text-end" dir="rtl"   placeholder= "کوئی تفصیل " name="description" id="description" ></textarea>
                </div>

                <div class="col-md-12 text-end">
                    <label for="selectedContractorStoreAmount" class="form-label"> : قل رقم</label>
                    <h3> '. $totalAmount .' </h3>
                    <input type="hidden" class="form-control text-end" id="selectedContractorStoreAmount" name="selectedContractorStoreAmount"
                    value='. $totalAmount .' readonly>
                </div>
                
                <div class="col-12 text-end">
                    <button type="submit" class="btn btn-primary" name="submitcontractorkhata">حساب میں جمع کریں</button>
                </div>';

    $table = "contractorkhata";
    $columns = "*";
    $where = " fkContractorId = ". $pkContractorId;
    $orderBy = " pkContractorKhataId Desc";
    $join =  " Join contractors ON fkContractorId = pkContractorId ";
    $limit = null;
    $tableResult = $CrudOperation->readRecords($table, $columns, $where, null, $join, $limit, null,$orderBy);
    $pagination = $CrudOperation->pagination($table, $where, null, $limit);

    $contractorBathaTable = '
<table id="example" class="table table-striped" style="width:100%">
<thead>
    <tr style="background-color:black;">
        <th style="color: azure; background-color:black;" class="text-end">ٹوٹل رقم</th>
        <th style="color: azure; background-color:black;" class="text-end">کل قیمت</th>
        <th style="color: azure; background-color:black;" class="text-end">ریٹ </th>
        <th style="color: azure; background-color:black;" class="text-end">ٹن/پیمائش</th>
        <th style="color: azure; background-color:black;" class="text-end">سائٹ</th>
        <th style="color: azure; background-color:black;" class="text-end">مواد کی قسم</th>
        <th style="color: azure; background-color:black;" class="text-end">گاڑی کا نمبر</th>
        <th style="color: azure; background-color:black;" class="text-end">تفصیل</th>
        <th style="color: azure; background-color:black;" class="text-end">تاریخ</th>
        <th style="color: azure; background-color:black;" class="text-end">سیریل</th>
    </tr>
</thead>
<tbody>
    ';

    if (empty($tableResult)) {
        $contractorBathaTable .= '
            <tr class="bg-info">
                <td style="text-align: center;"> </td>
                <td style="text-align: center;"> </td>
                <td style="text-align: center;"> </td>
                <td style="text-align: center;"> </td>
                <td style="text-align: center;"> </td>
                <td style="text-align: center;"> No Record Found</td>
                <td style="text-align: center;"> </td>
                <td style="text-align: center;"> </td>
                <td style="text-align: center;"> </td>
                <td style="text-align: center;"> </td>
                <td style="text-align: center;"> </td>
            </tr>
        ';
        }else{
        $pkContractorKhataId = 0;
        foreach($tableResult as $value){
        $pkContractorKhataId++;
        $processDescription = (strlen($value['processDescription']) > 25) ? substr($value['processDescription'], 0, 30) . '...' : $value['processDescription'];

        $contractorBathaTable .=  '
        <tr>
            <td class="text-end" >'. $value['totalAmount'] .'</td>
            <td class="text-end" >'. $value['allowance'] .'</td>
            <td class="text-end" >'. $value['price'] .'</td>
            <td class="text-end" >'. $value['measurement'] .'</td>
            <td class="text-end" >'. $value['destinationAddress'] .'</td>
            <td class="text-end" >'. $value['material'] .'</td>
            <td class="text-end" >'. $value['vehicleRegistrationNo'] .'</td>

            <td class="customTooltip text-end" >
                <div class="customTooltip">' . $processDescription . '
                    <span class="tooltiptext">' . $value['processDescription'] . '</span>
                </div>
            </td>
            <td class="text-end">'. $value['createdOn'] .'</td>
            <td class="text-end">'. $pkContractorKhataId .'</td>
        </tr>
            ';
        }
    }


    $contractorBathaTable .=     '
    
</tbody>
<tfoot>
    <tr style="background-color:black;color: azure;">
        <th style="color: azure; background-color:black;" class="text-end">ٹوٹل رقم</th>
        <th style="color: azure; background-color:black;" class="text-end">کل قیمت</th>
        <th style="color: azure; background-color:black;" class="text-end">ریٹ </th>
        <th style="color: azure; background-color:black;" class="text-end">ٹن/پیمائش</th>
        <th style="color: azure; background-color:black;" class="text-end">سائٹ</th>
        <th style="color: azure; background-color:black;" class="text-end">مواد کی قسم</th>
        <th style="color: azure; background-color:black;" class="text-end">گاڑی کا نمبر</th>
        <th style="color: azure; background-color:black;" class="text-end">تفصیل</th>
        <th style="color: azure; background-color:black;" class="text-end">تاریخ</th>
        <th style="color: azure; background-color:black;" class="text-end">سیریل</th>
    </tr>
</tfoot>
</table>';
    

    $response = array('table' => $contractorBathaTable, 'form' => $contractorBathaForm , 'pagination' => $pagination);
    echo json_encode($response);
} else {
    echo json_encode("Invalid request.");
}

?>
